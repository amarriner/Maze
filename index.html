<!doctype html>
<html>
    <head>
        <title>Maze</title>
        <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
        
        <script src="js/jquery-1.11.0.min.js"></script>
        <script src="js/phaser.min.js"></script>
        
        <script type="text/javascript">
            var MAX_X = 25;
            var MAX_Y = 15;
            
            var player;
            var cursors;
            var keyPressed = false;
            var up, down, left, right;
            
            var squareStack = [];
            var mazeGrid    = [[]];
            
            function Player(x, y, sprite) {
                this.x      = x;
                this.y      = y;
                this.sprite = sprite;
                
                this.move = function (x, y, wall) {
                    if (! wall) {
                        this.x = x;
                        this.y = y;
                    
                        this.sprite.x = this.x * 30;
                        this.sprite.y = this.y * 30;
                    }
                    
                    keyPressed = false;
                }
            }
            
            function Square(x, y) {
                this.north = 1;
                this.south = 1;
                this.east  = 1;
                this.west  = 1;
                
                this.x     = x;
                this.y     = y;
            }
            
            function generateMaze(startX, startY) {
                var i, j;
                var x, y;
                var sides = [];
                var square = new Square(startX, startY);
                squareStack.push(square);
                
                for (i = 0; i < MAX_X; i++) {
                    mazeGrid[i] = [];
                    for(j = 0; j < MAX_Y; j++) {
                        mazeGrid[i][j] = 0;
                    }
                }
                
                mazeGrid[square.x][square.y] = square;
                
                var cnt = 0;
                var mazeCount = 0;
                while(squareStack.length > 0 && cnt < 1000) {
                    sides = [];
                    
                    for(i = square.x - 1; i <= square.x + 1; i++) {
                        for (j = square.y - 1; j <= square.y + 1; j++) {
                            x = (i < 0) ? 0 : i;
                            x = (x >= MAX_X) ? MAX_X - 1 : x;
                            y = (y < 0) ? 0 : j;
                            y = (y >= MAX_Y) ? MAX_Y - 1 : y;
                     
                            if (! (x == square.x && y == square.y) &&
                                  (x == square.x || y == square.y) && 
                                  (mazeGrid[x][y] == 0)) {
                                sides.push(new Square(x, y));
                            }
                        }
                    }
                    
                    if (sides.length > 0) {
                        
                        var newSquare = sides[Math.floor(Math.random() * sides.length)];
                        
                        if (newSquare.y < square.y) {
                            square.north = 0;
                            newSquare.south = 0;
                        }
                        
                        if (newSquare.y > square.y) {
                            square.south = 0;
                            newSquare.north = 0;
                        }
                        
                        if (newSquare.x < square.x) {
                            square.west = 0;
                            newSquare.east = 0;
                        }
                        
                        if (newSquare.x > square.x) {
                            square.east = 0;
                            newSquare.west = 0;
                        }
                        
                        squareStack.push(square);
                        mazeGrid[newSquare.x][newSquare.y] = newSquare;
                        // if (cnt < 50) 
                            // console.log('Moving to sqare ' + newSquare.x + ',' + newSquare.y);
                        square = newSquare;
                        mazeCount++;
                    }
                    else {
                        square = squareStack.pop();
                        square = mazeGrid[square.x][square.y];
                        // if (cnt < 50)
                            // console.log('Popping square ' + square.x + ',' + square.y + ' from stack'); 
                    }

                    cnt++;
                }
                
                for(i = 0; i < MAX_X; i++) {
                    for (j = 0; j < MAX_Y; j++) {
                        s = mazeGrid[i][j];
                        if (s == 0) 
                            s = new Square(i, j);
                        
                        // console.log('(' + s.x + ',' + s.y + ') ' + s.north + s.south + s.east + s.west);
                        
                        maze.add.sprite(i * 30, i * 30, 'all');
                        
                        
                        if (s.north && s.south && 
                            s.east  && s.west)
                            maze.add.sprite(i * 30, j * 30, 'full');
                        
                        if (s.north) 
                            maze.add.sprite(i * 30, j * 30, 'north');

                        if (s.south) 
                            maze.add.sprite(i * 30, j * 30, 'south');

                        if (s.east) 
                            maze.add.sprite(i * 30, j * 30, 'east');

                        if (s.west) 
                            maze.add.sprite(i * 30, j * 30, 'west');

                    }
                }
            }
            
            var maze = new Phaser.Game(5 * 30, 5 * 30, Phaser.AUTO, 'maze',
                                          {preload: preload,
                                            create: create,
                                            update: update});
            
            function preload() {
                maze.load.image('all', 'assets/all.png');
                maze.load.image('full', 'assets/full.png');
                maze.load.image('north', 'assets/north.png');
                maze.load.image('south', 'assets/south.png');
                maze.load.image('east', 'assets/east.png');
                maze.load.image('west', 'assets/west.png');
                
                maze.load.image('player', 'assets/player.png');
                maze.load.image('end', 'assets/end.png');
            }
            
            function create() {
                maze.world.setBounds(0, 0, MAX_X * 30, MAX_Y * 30);
                maze.stage.backgroundColor = '#ffffff';
                
                var startX = Math.floor(Math.random() * (MAX_X - 12)) + 12;
                var startY = Math.floor(Math.random() * (MAX_Y -  7)) +  7;
                // console.log('Starting at square ' + startX + ',' + startY);
                generateMaze(startX, startY);
                maze.add.sprite(startX * 30, startY * 30, 'end');
            
                startX = Math.floor(Math.random() * (MAX_X - 12)) + 12;
                startY = Math.floor(Math.random() * (MAX_Y -  7)) +  7;
                // console.log('Moving player to ' + startX + ',' + startY);
                player = new Player(startX, startY, maze.add.sprite(startX * 30, startY * 30, 'player'));
                //player.sprite.fixedToCamera = true;
                //player.sprite.cameraOffset.x = 60;
                //player.sprite.cameraOffset.y = 60;
                
                maze.camera.follow(player.sprite);
                
                up = maze.input.keyboard.addKey(Phaser.Keyboard.UP);
                up.onUp.add(function() { player.move(player.x, player.y - 1, mazeGrid[player.x][player.y].north); }, this);
                up.onDown.add(function() { keyPressed = true; }, this);
                
                down = maze.input.keyboard.addKey(Phaser.Keyboard.DOWN);
                down.onUp.add(function() { player.move(player.x, player.y + 1, mazeGrid[player.x][player.y].south); }, this);
                down.onDown.add(function() { keyPressed = true; }, this);

                left = maze.input.keyboard.addKey(Phaser.Keyboard.LEFT);
                left.onUp.add(function() { player.move(player.x - 1, player.y, mazeGrid[player.x][player.y].west); }, this);
                left.onDown.add(function() { keyPressed = true; }, this);

                right = maze.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
                right.onUp.add(function() { player.move(player.x + 1, player.y, mazeGrid[player.x][player.y].east); }, this);
                right.onDown.add(function() { keyPressed = true; }, this);

            }
            
            function update() {
            }
                        
            
        </script>
    </head>
    <body>
        <div id="maze">
        </div>
        
    </body>
</html>